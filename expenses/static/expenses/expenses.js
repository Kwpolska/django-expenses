/*! For license information please see expenses.js.LICENSE.txt */
(()=>{"use strict";function e(e){var t=document.querySelector(e),n=parseInt(t.dataset.last_aid)+1;return t.dataset.last_aid=n.toString(),n}function t(e){return e.target.closest("tr")}function n(e){return isNaN(e)?n(0):new Intl.NumberFormat(_expConfig_.currencyLocale.replace("_","-"),{style:"currency",currency:_expConfig_.currencyCode}).format(e)}var i="expenses-autocomplete-hidden",a="expenses-autocomplete-hiding",l=function(){function e(e,t,n,i,a,l){this.input=e,this.name=void 0===t||null==t?e.name:t,this.url=n,this.hiddenByLength=!1,this.hiddenBySelection=null,this.previousCount=0,this.keyboardSelection=-1,this.hideTimeout=null,this.entries=[],this.minLength=null==i?1:i,this.displayHandler=a,this.selectHandler=l,this.popperInstance=null,this.buildAcDiv()}return e.prototype.buildAcDiv=function(){this.acDiv=document.createElement("div");var e="acd_"+this.name.replace(".","");this.acDiv.className="dropdown-menu expenses-autocomplete-menu",this.acDiv.id=e,this.acDiv.addEventListener("mousedown",(function(e){e.stopPropagation(),e.preventDefault()})),this.input.setAttribute("autocomplete","off"),this.input.nextSibling?this.input.parentElement.insertBefore(this.acDiv,this.input.nextSibling):this.input.parentElement.appendChild(this.acDiv),0===this.minLength&&this.buildCompletions(null),this.addInputListeners()},e.prototype.addInputListeners=function(){var e=this;this.input.addEventListener("keydown",this.handleKeyDown.bind(this)),this.input.addEventListener("input",this.buildCompletions.bind(this)),this.input.addEventListener("change",this.buildCompletions.bind(this)),this.input.addEventListener("focus",(function(){return e.focusInput()})),this.input.addEventListener("blur",(function(){return e.blurInput()}))},e.prototype.buildCompletions=function(e){var t,n=this;t="string"!=typeof this.url?this.url():this.url;var i=this.input.value.trim();if("off"!==this.input.dataset.autocomplete){if(i.length<this.minLength)return this.hiddenByLength=!0,this.acDiv.innerHTML="",void this.hideAcDiv();this.hiddenByLength?(this.unhideAcDiv(),this.hiddenByLength=!1):null!==this.hiddenBySelection&&(this.unhideAcDiv(),this.hiddenBySelection=null),this.createPopper(),-1!==t.indexOf("?")?t+="&q="+encodeURIComponent(i):t+="?q="+encodeURIComponent(i);var a=this;fetch(t).then((function(e){return e.json()})).then((function(e){a.previousCount=a.entries.length,a.entries=e,a.acDiv.innerHTML="";var t=0;e.forEach((function(e){var n=document.createElement("button");n.type="button",n.className="dropdown-item",n.dataset.id=t.toString(),t++,n.innerText=a.getDisplayText(e),n.addEventListener("click",(function(t){return a.select(e)})),a.acDiv.appendChild(n)})),n.resetKeyboardSelection(),n.popperInstance.update()}))}},e.prototype.getDisplayText=function(e){return void 0!==this.displayHandler?this.displayHandler(e):e},e.prototype.select=function(e){var t=this;void 0!==this.selectHandler?this.selectHandler(e):this.input.value=this.getDisplayText(e),this.setKeyboardSelection(null),this.input.focus(),this.hiddenBySelection=e,setTimeout((function(){return t.hideAcDiv()}),10)},e.prototype.focusInput=function(){""===this.input.value.trim()&&(this.acDiv.innerHTML=""),this.unhideAcDiv()},e.prototype.blurInput=function(){var e=this;setTimeout(function(){return e.hideAcDiv()}.bind(this),100)},e.prototype.unhideAcDiv=function(){null!==this.hideTimeout&&clearTimeout(this.hideTimeout),this.createPopper(),this.acDiv.classList.remove(i),this.acDiv.classList.remove(a)},e.prototype.hideAcDiv=function(){var e=this;null!==this.hideTimeout&&clearTimeout(this.hideTimeout),this.acDiv.classList.add(a),this.hideTimeout=setTimeout(function(){e.acDiv.classList.remove(a),e.acDiv.classList.add(i),e.destroyPopper()}.bind(this),110)},e.prototype.createPopper=function(){null==this.popperInstance&&(this.popperInstance=Popper.createPopper(this.input,this.acDiv,{placement:"bottom-start",modifiers:[{name:"flip",enabled:!0}]}))},e.prototype.destroyPopper=function(){null!=this.popperInstance&&(this.popperInstance.destroy(),this.popperInstance=null)},e.prototype.handleKeyDown=function(e){"ArrowDown"===e.key?(this.setKeyboardSelection(this.keyboardSelection+1),e.preventDefault()):"ArrowUp"===e.key?(this.setKeyboardSelection(this.keyboardSelection-1),e.preventDefault()):"Enter"===e.key&&this.keyboardSelection>=0&&(this.select(this.entries[this.keyboardSelection]),this.setKeyboardSelection(null),e.preventDefault())},e.prototype.resetKeyboardSelection=function(){this.entries.length!==this.previousCount&&this.setKeyboardSelection(0)},e.prototype.setKeyboardSelection=function(e){this.acDiv.querySelectorAll("button").forEach((function(e){return e.classList.remove("active")})),null!==e?(e<0&&(e=0),e>=this.entries.length&&(e=this.entries.length-1),this.keyboardSelection=e,this.acDiv.querySelector('button[data-id="'.concat(e,'"]')).classList.add("active")):this.keyboardSelection=-1},e}();function r(e,t,n,i,a,r){var s="string"==typeof e?document.querySelector(e):e;if(null!==s&&null!=s)return new l(s,t,n,i,a,r)}var s=["expenses-billtable-serving","expenses-billtable-count","expenses-billtable-unitprice"];function o(e){d(t(e))}function c(e){return e.split(" ").filter((function(e){return"bg-info-subtle"!=e&&"bg-success-subtle"!=e})).join(" ")}function d(e){var t=e.getElementsByClassName("expenses-billtable-unitprice")[0],i=e.getElementsByClassName("expenses-billtable-count")[0],a=t.getElementsByTagName("input")[0],l=i.getElementsByTagName("input")[0],r=e.getElementsByClassName("expenses-billtable-amount")[0],s=parseFloat(a.value)*parseFloat(l.value);r.innerText=n(s),r.dataset.value=s.toString(),u()}function u(){for(var e=document.querySelectorAll("td.expenses-billtable-amount"),t=0,i=0;i<e.length;i++){var a=parseFloat(e[i].dataset.value);isNaN(a)||(t+=a)}document.querySelector(".expenses-bill-total").innerText=n(t)}function p(){document.querySelector("#expenses-billtable-savechanges").disabled=!1}function h(e){var t,n,i={edit:{classNames:"btn-outline-info expenses-billtable-btn-edit",title:gettext("Edit"),icon:"fa-edit",callback:f},undo:{classNames:"btn-outline-warning expenses-billtable-btn-undo",title:gettext("Undo Changes"),icon:"fa-undo",callback:x},delete:{classNames:"btn-outline-danger expenses-billtable-btn-delete",title:gettext("Delete"),icon:"fa-trash-alt",callback:y},accept:{classNames:"btn-outline-success expenses-billtable-btn-accept",title:gettext("Accept"),icon:"fa-check",callback:g}};return t=e.map((function(e){return i[e]})),(n=document.createElement("div")).className="btn-group",n.setAttribute("role","group"),n.setAttribute("aria-label",gettext("Item actions")),t.forEach((function(e){var t=document.createElement("button");t.type="button",t.className="btn "+e.classNames,t.title=e.title,t.innerHTML='<i class="fa fa-fw '.concat(e.icon,'"></i>'),t.addEventListener("click",e.callback),n.appendChild(t)})),n}function m(){document.querySelector("#expenses-billtable-addrow .expenses-billtable-product input").focus()}function b(t){var i=document.querySelector("#expenses-billtable-addrow"),a=document.createElement("tr"),l="a"+e("#expenses-billtable-form");a.dataset.id=l,v(a,i,l,"add",["edit","delete"]),i.getElementsByClassName("expenses-billtable-amount")[0].innerText=n(0),document.querySelector("#expenses-billtable tbody").insertBefore(a,i),i.querySelectorAll("input").forEach((function(e){void 0!==e.dataset.default?e.value=e.dataset.default:e.value=""})),delete i.querySelector(".expenses-billtable-amount").dataset.value,p(),m()}function v(e,t,i,a,l){e.dataset.type=a;for(var r=t.querySelectorAll("input"),o={},d=0;d<r.length;d++){var u=r[d];if(!u.reportValidity())throw new Error("Field ".concat(u.name," was invalid."));var p=document.createElement("td"),m=u.parentElement;m.dataset.hasOwnProperty("orig_text")&&(p.dataset.orig_text=m.dataset.orig_text,p.dataset.orig_value=m.dataset.orig_value),p.className=c(u.parentElement.className),p.classList.add("edit"==a?"bg-info-subtle":"bg-success-subtle");var b=document.createElement("input");b.hidden=!0,b.value=u.value;var v=u.name;-1==v.indexOf("__")?b.name="".concat(i,"__").concat(v):b.name=v,p.appendChild(b);var f=u.value;p.className.includes("expenses-billtable-unitprice")&&(f=n(parseFloat(u.value)),p.dataset.value=u.value),p.appendChild(document.createTextNode(f)),e.appendChild(p),-1!=s.indexOf(c(p.className))?o[u.name]=parseFloat(u.value):o[u.name]=u.value}var y=t.getElementsByClassName("expenses-billtable-amount")[0],x=document.createElement("td");x.className="expenses-billtable-amount",x.innerText=y.innerText,x.dataset.value=y.dataset.value,x.classList.add("edit"==a?"bg-info-subtle":"bg-success-subtle"),y.dataset.hasOwnProperty("orig_text")&&(x.dataset.orig_text=y.dataset.orig_text,x.dataset.orig_value=y.dataset.orig_value),e.appendChild(x);var g=document.createElement("td");g.className="expenses-billtable-actions",g.innerHTML="",g.classList.add("edit"==a?"bg-info-subtle":"bg-success-subtle"),g.appendChild(h(l)),e.appendChild(g)}function f(e){for(var n=t(e),i=document.querySelector("#expenses-billtable-addrow"),a=0;a<n.children.length;a++){var l=n.children[a];if(l.className.includes("expenses-billtable-actions"))l.innerHTML="",l.appendChild(h(["accept","undo"]));else{var r=l.getElementsByTagName("input"),s="";s=r.length>0?r[0].value:l.dataset.value?l.dataset.value:l.innerText.trim(),l.dataset.hasOwnProperty("orig_text")||(l.dataset.orig_text=l.innerText.trim(),l.dataset.orig_value=s.trim());var d=c(l.className),u=i.querySelector(".".concat(d," input"));if(null!==u){var m=u.cloneNode(),b=m.name;m.value=s,m.name="".concat(n.dataset.id,"__").concat(b),"count"!=b&&"unit_price"!=b||m.addEventListener("input",o),m.addEventListener("keypress",q),l.innerHTML="",l.appendChild(m)}}}p(),e.preventDefault()}function y(e){var n=t(e),i=n.dataset.id;if("add"!==n.dataset.type){var a=document.querySelector("#expenses-billtable-deletions"),l=document.createElement("input");l.hidden=!0,l.name="d__"+i,a.appendChild(l)}n.remove(),u(),p(),e.preventDefault()}function x(e){t(e).querySelectorAll("td").forEach((function(e){e.classList.remove("bg-info-subtle"),e.dataset.hasOwnProperty("orig_text")&&(e.innerText=e.dataset.orig_text,e.dataset.value=e.dataset.orig_value),e.className.includes("expenses-billtable-actions")&&(e.innerHTML="",e.appendChild(h(["edit","delete"])))})),u(),e.preventDefault()}function g(e){S(t(e))}function S(e){var t=e.dataset.id,n=document.createElement("tr");n.dataset.id=t,v(n,e,t,function(e){return"a"==e.charAt(0)}(t)?"add":"edit",["edit","undo","delete"]),e.parentElement.replaceChild(n,e)}function E(){var e=document.querySelector("#expenses-billtable-addrow").querySelectorAll("input");e.forEach((function(e){return e.disabled=!0}));try{document.querySelectorAll(".expenses-billtable-btn-accept").forEach((function(e){return S(e.closest("tr"))})),document.querySelector("#expenses-billtable-form").submit()}catch(t){e.forEach((function(e){return e.disabled=!1})),event.preventDefault()}}function q(e){if(13==e.keyCode){if(e.metaKey||e.ctrlKey)E();else{var n=t(e);"expenses-billtable-addrow"===n.id?b():S(n)}return!1}}function L(t){var n=document.querySelector("#expenses-bulkcatedit-addrow"),i=document.createElement("tr");i.classList.add("table-success");for(var a="a"+e("#expenses-bulkcatedit-form"),l=n.querySelectorAll("input"),r=0;r<l.length;r++){var s=l[r];if(!s.reportValidity())throw new Error("Field ".concat(s.name," was invalid."));var o=document.createElement("td");o.className=s.closest("td").className;var c=s.cloneNode();c.name=c.name.replace("add_","add_".concat(a,"_")),c.addEventListener("keypress",T),o.appendChild(c),i.appendChild(o)}var d=document.createElement("td");d.className="expenses-bulkcatedit-actions";var u=document.createElement("btn");u.className="btn btn-danger",u.innerHTML='<i class="fa fa-fw fa-trash-alt"></i>',u.addEventListener("click",k),d.appendChild(u),i.appendChild(d),document.querySelector("#expenses-bulkcatedit-form tbody").insertBefore(i,n),l.forEach((function(e){return e.value=""}))}function k(e){t(e).remove()}function w(e){document.querySelectorAll("#expenses-bulkcatedit-addrow input").forEach((function(e){return e.disabled=!0}));var t=document.querySelector("#expenses-bulkcatedit-form");t.reportValidity()?t.submit():document.querySelectorAll("#expenses-bulkcatedit-addrow input").forEach((function(e){return e.disabled=!1})),null!==e&&e.preventDefault()}function T(e){if(13==e.keyCode){if("expenses-bulkcatedit-addrow"===t(e).id){var n=document.querySelector("#expenses-bulkcatedit-addrow").querySelectorAll("input");""===n[0].value&&""===n[1].value?w(null):L()}else w(null);return!1}}function D(e){var t=document.querySelector("#search-date-start"),n=document.querySelector("#search-date-end");document.querySelector("#search-date-spec-any").checked?(t.disabled=!0,n.disabled=!0):(t.disabled=!1,n.disabled=!1)}function _(e){var t=document.querySelector("#search-include-expenses"),n=document.querySelector("#search-include-bills");document.querySelector("#search-for-expenses").checked?(t.disabled=!1,n.disabled=!1):(t.disabled=!0,n.disabled=!0)}function C(e){e.amount.required="menu"!==e.type.value,e.amount.disabled="menu"===e.type.value}var N={};function A(e){var t=e.target,n=document.getElementById(t.dataset.target);n.disabled=!t.checked,t.checked&&n.focus()}document.addEventListener("DOMContentLoaded",(function(){var e,t,i;r(".expenses-addform-vendor","vendor",(e=_expConfig_.baseUrl)+"api/autocomplete/expense/vendor/"),r(".expenses-billaddform-vendor","vendor",e+"api/autocomplete/bill/vendor/"),r(".expenses-addform-description","description",(function(){var t=document.querySelector(".expenses-addform-vendor").value.trim();return 0==t.length?e+"api/autocomplete/expense/description/":e+"api/autocomplete/expense/description/?vendor="+encodeURIComponent(t)})),null!==document.querySelector("#expenses-billtable-form")&&function(){var e=document.querySelector("#expenses-billtable-btn-add");e.type="button",e.addEventListener("click",b),document.querySelectorAll(".expenses-billtable-btn-edit").forEach((function(e){return e.addEventListener("click",f)})),document.querySelectorAll(".expenses-billtable-btn-delete").forEach((function(e){return e.addEventListener("click",y)})),document.querySelector("#expenses-billtable-addrow .expenses-billtable-unitprice input").addEventListener("input",o),document.querySelector("#expenses-billtable-addrow .expenses-billtable-count input").addEventListener("input",o),document.querySelector("#expenses-billtable-addrow .expenses-billtable-amount").innerText=n(0),document.querySelectorAll("#expenses-billtable-addrow input").forEach((function(e){return e.addEventListener("keydown",q)})),document.querySelector("#expenses-billtable-savechanges").addEventListener("click",E);var t=document.querySelector("#expenses-billtable-form");t.action="",t.dataset.last_aid="0";var i=document.querySelector("#expenses-billtable-addrow .expenses-billtable-product input");r(i,null,(function(){var e=document.querySelector("#expenses-bill-meta-vendor").innerText;return _expConfig_.baseUrl+"api/autocomplete/bill/item/?vendor="+encodeURIComponent(e)}),3,(function(e){var t=e,n=t.serving?" ‚öñÔ∏è".concat(t.serving):"";return"‚ú® ".concat(t.product).concat(n," üí∂").concat(t.unit_price)}),(function(e){var t=e,n=document.querySelector("#expenses-billtable-addrow");i.dataset.autocomplete="off",n.querySelector(".expenses-billtable-product input").value=t.product,n.querySelector(".expenses-billtable-serving input").value=null!==t.serving?t.serving.toString():"",n.querySelector(".expenses-billtable-unitprice input").value=t.unit_price.toString(),i.dataset.autocomplete="on",d(n)})),m()}(),null!==document.querySelector("#expenses-bulkcatedit-form")&&function(){var e=document.querySelector("#expenses-bulkcatedit-btn-add");e.type="button",e.addEventListener("click",L),document.querySelectorAll("#expenses-bulkcatedit-addrow input").forEach((function(e){e.disabled=!1,e.addEventListener("keypress",T)})),document.querySelectorAll("#expenses-bulkcatedit-addrow input").forEach((function(e){return e.addEventListener("keypress",T)}));var t=document.querySelector("#expenses-bulkcatedit-btn-save");t.type="button",t.addEventListener("click",w),document.querySelector("#expenses-bulkcatedit-form").dataset.last_aid="0"}(),null!==document.querySelector("#expenses-templateedit-form")&&(t=document.querySelector("#expenses-templateedit-form"),i=function(){return C(t)},t.type.forEach((function(e){return e.addEventListener("change",i)})),C(t)),null!==document.querySelector("#expenses-search-form")&&(document.querySelector("#search-for-expenses").addEventListener("click",_),document.querySelector("#search-for-billitems").addEventListener("click",_),_(),document.querySelector("#search-date-spec-any").addEventListener("click",D),document.querySelector("#search-date-spec-between").addEventListener("click",D),D()),document.querySelectorAll(".expenses-field-enabler").forEach((function(e){e.addEventListener("click",A),document.getElementById(e.dataset.target).disabled=!e.checked})),document.body.addEventListener("touchstart",(function(e){for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches[t];n.pageX<=20&&(N[n.identifier]=n.pageX)}})),document.body.addEventListener("touchmove",(function(e){for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches[t];N.hasOwnProperty(n.identifier)&&(N[n.identifier],n.pageX-N[n.identifier]>=100&&($(".navbar-collapse").collapse("show"),window.scrollTo(0,0),delete N[n.identifier]))}})),document.body.addEventListener("touchend",(function(e){for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches[t];N.hasOwnProperty(n.identifier)&&(N[n.identifier],n.pageX-N[n.identifier]>=100&&($(".navbar-collapse").collapse("show"),window.scrollTo(0,0)),delete N[n.identifier])}}))}),!1)})();