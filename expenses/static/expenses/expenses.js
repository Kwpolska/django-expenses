/*! For license information please see expenses.js.LICENSE.txt */
(()=>{"use strict";function e(e){var t=document.querySelector(e),n=parseInt(t.dataset.last_aid)+1;return t.dataset.last_aid=n.toString(),n}function t(e){return e.target.closest("tr")}function n(e){return isNaN(e)?n(0):new Intl.NumberFormat(_expConfig_.currencyLocale.replace("_","-"),{style:"currency",currency:_expConfig_.currencyCode}).format(e)}var a="expenses-autocomplete-hidden",i="expenses-autocomplete-hiding",l=function(){function e(e,t,n,a,i,l){this.input=e,this.name=void 0===t||null==t?e.name:t,this.url=n,this.hiddenByLength=!1,this.hiddenBySelection=null,this.previousCount=0,this.keyboardSelection=-1,this.hideTimeout=null,this.entries=[],this.minLength=null==a?1:a,this.displayHandler=i,this.selectHandler=l,this.popperInstance=null,this.buildAcDiv()}return e.prototype.buildAcDiv=function(){this.acDiv=document.createElement("div");var e="acd_"+this.name.replace(".","");this.acDiv.className="dropdown-menu expenses-autocomplete-menu",this.acDiv.id=e,this.acDiv.addEventListener("mousedown",(function(e){e.stopPropagation(),e.preventDefault()})),this.input.setAttribute("autocomplete","off"),this.input.nextSibling?this.input.parentElement.insertBefore(this.acDiv,this.input.nextSibling):this.input.parentElement.appendChild(this.acDiv),0===this.minLength&&this.buildCompletions(null),this.addInputListeners()},e.prototype.addInputListeners=function(){var e=this;this.input.addEventListener("keydown",this.handleKeyDown.bind(this)),this.input.addEventListener("input",this.buildCompletions.bind(this)),this.input.addEventListener("change",this.buildCompletions.bind(this)),this.input.addEventListener("focus",(function(){return e.focusInput()})),this.input.addEventListener("blur",(function(){return e.blurInput()}))},e.prototype.buildCompletions=function(e){var t,n=this;t="string"!=typeof this.url?this.url():this.url;var a=this.input.value.trim();if("off"!==this.input.dataset.autocomplete){if(a.length<this.minLength)return this.hiddenByLength=!0,this.acDiv.innerHTML="",void this.hideAcDiv();this.hiddenByLength?(this.unhideAcDiv(),this.hiddenByLength=!1):null!==this.hiddenBySelection&&(this.unhideAcDiv(),this.hiddenBySelection=null),this.createPopper(),-1!==t.indexOf("?")?t+="&q="+encodeURIComponent(a):t+="?q="+encodeURIComponent(a);var i=this;fetch(t).then((function(e){return e.json()})).then((function(e){i.previousCount=i.entries.length,i.entries=e,i.acDiv.innerHTML="";var t=0;e.forEach((function(e){var n=document.createElement("button");n.type="button",n.className="dropdown-item",n.dataset.id=t.toString(),t++,n.innerText=i.getDisplayText(e),n.addEventListener("click",(function(t){return i.select(e)})),i.acDiv.appendChild(n)})),n.resetKeyboardSelection(),n.popperInstance.update()}))}},e.prototype.getDisplayText=function(e){return void 0!==this.displayHandler?this.displayHandler(e):e},e.prototype.select=function(e){var t=this;void 0!==this.selectHandler?this.selectHandler(e):this.input.value=this.getDisplayText(e),this.setKeyboardSelection(null),this.input.focus(),this.hiddenBySelection=e,setTimeout((function(){return t.hideAcDiv()}),10)},e.prototype.focusInput=function(){""===this.input.value.trim()&&(this.acDiv.innerHTML=""),this.unhideAcDiv()},e.prototype.blurInput=function(){var e=this;setTimeout(function(){return e.hideAcDiv()}.bind(this),100)},e.prototype.unhideAcDiv=function(){null!==this.hideTimeout&&clearTimeout(this.hideTimeout),this.createPopper(),this.acDiv.classList.remove(a),this.acDiv.classList.remove(i)},e.prototype.hideAcDiv=function(){var e=this;null!==this.hideTimeout&&clearTimeout(this.hideTimeout),this.acDiv.classList.add(i),this.hideTimeout=setTimeout(function(){e.acDiv.classList.remove(i),e.acDiv.classList.add(a),e.destroyPopper()}.bind(this),110)},e.prototype.createPopper=function(){null==this.popperInstance&&(this.popperInstance=new Popper(this.input,this.acDiv,{placement:"bottom-start",modifiers:{flip:{enabled:!0}}}))},e.prototype.destroyPopper=function(){null!=this.popperInstance&&(this.popperInstance.destroy(),this.popperInstance=null)},e.prototype.handleKeyDown=function(e){"ArrowDown"===e.key?(this.setKeyboardSelection(this.keyboardSelection+1),e.preventDefault()):"ArrowUp"===e.key?(this.setKeyboardSelection(this.keyboardSelection-1),e.preventDefault()):"Enter"===e.key&&this.keyboardSelection>=0&&(this.select(this.entries[this.keyboardSelection]),this.setKeyboardSelection(null),e.preventDefault())},e.prototype.resetKeyboardSelection=function(){this.entries.length!==this.previousCount&&this.setKeyboardSelection(0)},e.prototype.setKeyboardSelection=function(e){this.acDiv.querySelectorAll("button").forEach((function(e){return e.classList.remove("active")})),null!==e?(e<0&&(e=0),e>=this.entries.length&&(e=this.entries.length-1),this.keyboardSelection=e,this.acDiv.querySelector('button[data-id="'.concat(e,'"]')).classList.add("active")):this.keyboardSelection=-1},e}();function r(e,t,n,a,i,r){var s="string"==typeof e?document.querySelector(e):e;if(null!==s&&null!=s)return new l(s,t,n,a,i,r)}var s=["expenses-billtable-serving","expenses-billtable-count","expenses-billtable-unitprice"];function o(e){c(t(e))}function c(e){var t=e.getElementsByClassName("expenses-billtable-unitprice")[0],a=e.getElementsByClassName("expenses-billtable-count")[0],i=t.getElementsByTagName("input")[0],l=a.getElementsByTagName("input")[0],r=e.getElementsByClassName("expenses-billtable-amount")[0],s=parseFloat(i.value)*parseFloat(l.value);r.innerText=n(s),r.dataset.value=s.toString(),d()}function d(){for(var e=document.querySelectorAll("td.expenses-billtable-amount"),t=0,a=0;a<e.length;a++){var i=parseFloat(e[a].dataset.value);isNaN(i)||(t+=i)}document.querySelector(".expenses-bill-total").innerText=n(t)}function u(){document.querySelector("#expenses-billtable-savechanges").disabled=!1}function p(e){var t,n,a={edit:{classNames:"btn-outline-info expenses-billtable-btn-edit",title:gettext("Edit"),icon:"fa-edit",callback:v},undo:{classNames:"btn-outline-warning expenses-billtable-btn-undo",title:gettext("Undo Changes"),icon:"fa-undo",callback:y},delete:{classNames:"btn-outline-danger expenses-billtable-btn-delete",title:gettext("Delete"),icon:"fa-trash-alt",callback:f},accept:{classNames:"btn-outline-success expenses-billtable-btn-accept",title:gettext("Accept"),icon:"fa-check",callback:x}};return t=e.map((function(e){return a[e]})),(n=document.createElement("div")).className="btn-group",n.setAttribute("role","group"),n.setAttribute("aria-label",gettext("Item actions")),t.forEach((function(e){var t=document.createElement("button");t.type="button",t.className="btn "+e.classNames,t.title=e.title,t.innerHTML='<i class="fa fa-fw '.concat(e.icon,'"></i>'),t.addEventListener("click",e.callback),n.appendChild(t)})),n}function h(){document.querySelector("#expenses-billtable-addrow .expenses-billtable-product input").focus()}function m(t){var a=document.querySelector("#expenses-billtable-addrow"),i=document.createElement("tr");i.classList.add("expenses-billtable-row","table-success");var l="a"+e("#expenses-billtable-form");i.dataset.id=l,b(i,a,l,"add",["edit","delete"]),a.getElementsByClassName("expenses-billtable-amount")[0].innerText=n(0),document.querySelector("#expenses-billtable tbody").insertBefore(i,a),a.querySelectorAll("input").forEach((function(e){void 0!==e.dataset.default?e.value=e.dataset.default:e.value=""})),delete a.querySelector(".expenses-billtable-amount").dataset.value,u(),h()}function b(e,t,a,i,l){e.dataset.type=i;for(var r=t.querySelectorAll("input"),o={},c=0;c<r.length;c++){var d=r[c];if(!d.reportValidity())throw new Error("Field ".concat(d.name," was invalid."));var u=document.createElement("td"),h=d.parentElement;h.dataset.hasOwnProperty("orig_text")&&(u.dataset.orig_text=h.dataset.orig_text,u.dataset.orig_value=h.dataset.orig_value),u.className=d.parentElement.className;var m=document.createElement("input");m.hidden=!0,m.value=d.value;var b=d.name;-1==b.indexOf("__")?m.name="".concat(a,"__").concat(b):m.name=b,u.appendChild(m);var v=d.value;"expenses-billtable-unitprice"==u.className&&(v=n(parseFloat(d.value)),u.dataset.value=d.value),u.appendChild(document.createTextNode(v)),e.appendChild(u),-1!=s.indexOf(u.className)?o[d.name]=parseFloat(d.value):o[d.name]=d.value}var f=t.getElementsByClassName("expenses-billtable-amount")[0],y=document.createElement("td");y.className="expenses-billtable-amount",y.innerText=f.innerText,y.dataset.value=f.dataset.value,f.dataset.hasOwnProperty("orig_text")&&(y.dataset.orig_text=f.dataset.orig_text,y.dataset.orig_value=f.dataset.orig_value),e.appendChild(y);var x=document.createElement("td");x.className="expenses-billtable-actions",x.innerHTML="",x.appendChild(p(l)),e.appendChild(x)}function v(e){for(var n=t(e),a=document.querySelector("#expenses-billtable-addrow"),i=0;i<n.children.length;i++){var l=n.children[i];if("expenses-billtable-actions"!=l.className){var r=l.getElementsByTagName("input"),s="";s=r.length>0?r[0].value:l.dataset.value?l.dataset.value:l.innerText.trim(),l.dataset.hasOwnProperty("orig_text")||(l.dataset.orig_text=l.innerText.trim(),l.dataset.orig_value=s.trim());var c=a.querySelector(".".concat(l.className," input"));if(null!==c){var d=c.cloneNode(),h=d.name;d.value=s,d.name="".concat(n.dataset.id,"__").concat(h),"count"!=h&&"unit_price"!=h||d.addEventListener("input",o),d.addEventListener("keypress",E),l.innerHTML="",l.appendChild(d)}}else l.innerHTML="",l.appendChild(p(["accept","undo"]))}u(),e.preventDefault()}function f(e){var n=t(e),a=n.dataset.id;if("add"!==n.dataset.type){var i=document.querySelector("#expenses-billtable-deletions"),l=document.createElement("input");l.hidden=!0,l.name="d__"+a,i.appendChild(l)}n.remove(),d(),u(),e.preventDefault()}function y(e){var n=t(e);n.classList.remove("table-info"),n.querySelectorAll("td").forEach((function(e){e.dataset.hasOwnProperty("orig_text")&&(e.innerText=e.dataset.orig_text,e.dataset.value=e.dataset.orig_value),"expenses-billtable-actions"==e.className&&(e.innerHTML="",e.appendChild(p(["edit","delete"])))})),d(),e.preventDefault()}function x(e){g(t(e))}function g(e){var t=e.dataset.id,n=document.createElement("tr");n.classList.add("expenses-billtable-row","table-info"),n.dataset.id=t,b(n,e,t,function(e){return"a"==e.charAt(0)}(t)?"add":"edit",["edit","undo","delete"]),e.parentElement.replaceChild(n,e)}function S(){var e=document.querySelector("#expenses-billtable-addrow").querySelectorAll("input");e.forEach((function(e){return e.disabled=!0}));try{document.querySelectorAll(".expenses-billtable-btn-accept").forEach((function(e){return g(e.closest("tr"))})),document.querySelector("#expenses-billtable-form").submit()}catch(t){e.forEach((function(e){return e.disabled=!1})),event.preventDefault()}}function E(e){if(13==e.keyCode){if(e.metaKey||e.ctrlKey)S();else{var n=t(e);"expenses-billtable-addrow"===n.id?m():g(n)}return!1}}function q(t){var n=document.querySelector("#expenses-bulkcatedit-addrow"),a=document.createElement("tr");a.classList.add("table-success");for(var i="a"+e("#expenses-bulkcatedit-form"),l=n.querySelectorAll("input"),r=0;r<l.length;r++){var s=l[r];if(!s.reportValidity())throw new Error("Field ".concat(s.name," was invalid."));var o=document.createElement("td");o.className=s.closest("td").className;var c=s.cloneNode();c.name=c.name.replace("add_","add_".concat(i,"_")),c.addEventListener("keypress",w),o.appendChild(c),a.appendChild(o)}var d=document.createElement("td");d.className="expenses-bulkcatedit-actions";var u=document.createElement("btn");u.className="btn btn-danger",u.innerHTML='<i class="fa fa-fw fa-trash-alt"></i>',u.addEventListener("click",L),d.appendChild(u),a.appendChild(d),document.querySelector("#expenses-bulkcatedit-form tbody").insertBefore(a,n),l.forEach((function(e){return e.value=""}))}function L(e){t(e).remove()}function k(e){document.querySelectorAll("#expenses-bulkcatedit-addrow input").forEach((function(e){return e.disabled=!0}));var t=document.querySelector("#expenses-bulkcatedit-form");t.reportValidity()?t.submit():document.querySelectorAll("#expenses-bulkcatedit-addrow input").forEach((function(e){return e.disabled=!1})),null!==e&&e.preventDefault()}function w(e){if(13==e.keyCode){if("expenses-bulkcatedit-addrow"===t(e).id){var n=document.querySelector("#expenses-bulkcatedit-addrow").querySelectorAll("input");""===n[0].value&&""===n[1].value?k(null):q()}else k(null);return!1}}function T(e){var t=document.querySelector("#search-date-start"),n=document.querySelector("#search-date-end");document.querySelector("#search-date-spec-any").checked?(t.disabled=!0,n.disabled=!0):(t.disabled=!1,n.disabled=!1)}function D(e){var t=document.querySelector("#search-include-expenses"),n=document.querySelector("#search-include-bills");document.querySelector("#search-for-expenses").checked?(t.disabled=!1,n.disabled=!1):(t.disabled=!0,n.disabled=!0)}function _(e){e.amount.required="menu"!==e.type.value,e.amount.disabled="menu"===e.type.value}var C={};function N(e){var t=e.target,n=document.getElementById(t.dataset.target);n.disabled=!t.checked,t.checked&&n.focus()}document.addEventListener("DOMContentLoaded",(function(){var e,t,a;if(r(".expenses-addform-vendor","vendor",(e=_expConfig_.baseUrl)+"api/autocomplete/expense/vendor/"),r(".expenses-billaddform-vendor","vendor",e+"api/autocomplete/bill/vendor/"),r(".expenses-addform-description","description",(function(){var t=document.querySelector(".expenses-addform-vendor").value.trim();return 0==t.length?e+"api/autocomplete/expense/description/":e+"api/autocomplete/expense/description/?vendor="+encodeURIComponent(t)})),null!==document.querySelector("#expenses-billtable-form")&&function(){var e=document.querySelector("#expenses-billtable-btn-add");e.type="button",e.addEventListener("click",m),document.querySelectorAll(".expenses-billtable-btn-edit").forEach((function(e){return e.addEventListener("click",v)})),document.querySelectorAll(".expenses-billtable-btn-delete").forEach((function(e){return e.addEventListener("click",f)})),document.querySelector("#expenses-billtable-addrow .expenses-billtable-unitprice input").addEventListener("input",o),document.querySelector("#expenses-billtable-addrow .expenses-billtable-count input").addEventListener("input",o),document.querySelector("#expenses-billtable-addrow .expenses-billtable-amount").innerText=n(0),document.querySelectorAll("#expenses-billtable-addrow input").forEach((function(e){return e.addEventListener("keydown",E)})),document.querySelector("#expenses-billtable-savechanges").addEventListener("click",S);var t=document.querySelector("#expenses-billtable-form");t.action="",t.dataset.last_aid="0";var a=document.querySelector("#expenses-billtable-addrow .expenses-billtable-product input");r(a,null,(function(){var e=document.querySelector("#expenses-bill-meta-vendor").innerText;return _expConfig_.baseUrl+"api/autocomplete/bill/item/?vendor="+encodeURIComponent(e)}),3,(function(e){var t=e,n=t.serving?" ⚖️".concat(t.serving):"";return"✨ ".concat(t.product).concat(n," 💶").concat(t.unit_price)}),(function(e){var t=e,n=document.querySelector("#expenses-billtable-addrow");a.dataset.autocomplete="off",n.querySelector(".expenses-billtable-product input").value=t.product,n.querySelector(".expenses-billtable-serving input").value=null!==t.serving?t.serving.toString():"",n.querySelector(".expenses-billtable-unitprice input").value=t.unit_price.toString(),a.dataset.autocomplete="on",c(n)})),h()}(),null!==document.querySelector("#expenses-bulkcatedit-form")&&function(){var e=document.querySelector("#expenses-bulkcatedit-btn-add");e.type="button",e.addEventListener("click",q),document.querySelectorAll("#expenses-bulkcatedit-addrow input").forEach((function(e){e.disabled=!1,e.addEventListener("keypress",w)})),document.querySelectorAll("#expenses-bulkcatedit-addrow input").forEach((function(e){return e.addEventListener("keypress",w)}));var t=document.querySelector("#expenses-bulkcatedit-btn-save");t.type="button",t.addEventListener("click",k),document.querySelector("#expenses-bulkcatedit-form").dataset.last_aid="0"}(),null!==document.querySelector("#expenses-templateedit-form")&&(t=document.querySelector("#expenses-templateedit-form"),a=function(){return _(t)},t.type.forEach((function(e){return e.addEventListener("change",a)})),_(t)),null!==document.querySelector("#expenses-search-form")&&(document.querySelector("#search-for-expenses").addEventListener("click",D),document.querySelector("#search-for-billitems").addEventListener("click",D),D(),document.querySelector("#search-date-spec-any").addEventListener("click",T),document.querySelector("#search-date-spec-between").addEventListener("click",T),T()),document.querySelectorAll(".expenses-field-enabler").forEach((function(e){e.addEventListener("click",N),document.getElementById(e.dataset.target).disabled=!e.checked})),-1!=navigator.userAgent.indexOf("ExpensesWebView")){var i=document.querySelector(".navbar-kw");i.classList.remove("static-top"),i.classList.add("fixed-top"),document.querySelector("body").style.paddingTop="50px"}document.body.addEventListener("touchstart",(function(e){for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches[t];n.pageX<=20&&(C[n.identifier]=n.pageX)}})),document.body.addEventListener("touchmove",(function(e){for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches[t];C.hasOwnProperty(n.identifier)&&(C[n.identifier],n.pageX-C[n.identifier]>=100&&($(".navbar-collapse").collapse("show"),window.scrollTo(0,0),delete C[n.identifier]))}})),document.body.addEventListener("touchend",(function(e){for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches[t];C.hasOwnProperty(n.identifier)&&(C[n.identifier],n.pageX-C[n.identifier]>=100&&($(".navbar-collapse").collapse("show"),window.scrollTo(0,0)),delete C[n.identifier])}}))}),!1)})();